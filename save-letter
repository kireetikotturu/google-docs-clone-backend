app.post("/save-letter", verifyToken, async (req, res) => {
  try {
    const { letter, userToken } = req.body;
    console.log("ğŸ”¹ Received userToken:", userToken); // ğŸ”¥ Debugging: Check if frontend is sending token

    if (!userToken) {
      console.error("âŒ No Google OAuth token received from frontend.");
      return res.status(401).json({ message: "âŒ Unauthorized: No Google OAuth token provided" });
    }

    // ğŸ”¹ Authenticate user with Google OAuth2
    const oauth2Client = new OAuth2Client();
    oauth2Client.setCredentials({ access_token: userToken });

    // âœ… Save to MongoDB
    const newLetter = new Letter({ content: letter, userId: req.user.uid });
    await newLetter.save();
    console.log("âœ… Letter saved to MongoDB:", newLetter._id);

    // âœ… Save to Google Drive
    console.log("ğŸ”¹ Uploading file to Google Drive...");
    const fileId = await uploadToDrive(letter, oauth2Client);

    res.json({ message: "âœ… Letter saved successfully!", letter: newLetter, fileId });
  } catch (error) {
    console.error("âŒ Error saving letter:", error);
    res.status(500).json({ message: "âŒ Error saving letter" });
  }
});
